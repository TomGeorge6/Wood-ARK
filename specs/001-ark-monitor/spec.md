# Feature Specification: ARK 持仓监控与企微推送系统

**Feature Branch**: `001-ark-monitor`  
**Created**: 2025-11-13  
**Status**: Draft  
**Input**: 构建 ARK 基金持仓监控系统，每日自动下载并分析 ARK 旗下 5 只 ETF 的持仓变化，通过企业微信推送每日报告

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 自动接收每日持仓报告 (Priority: P1)

作为投资者，我希望每天早上自动收到 ARK 基金的持仓变化报告，这样我可以在上班路上快速了解木头姐的最新投资动向，无需手动访问 ARK 官网查看。

**Why this priority**: 这是系统的核心价值主张。99% 的用户场景都是被动接收报告，而非主动查询。自动推送能节省用户每天 5-10 分钟的手动查看时间。

**Independent Test**: 可通过配置定时任务，在测试环境运行一次完整流程（下载数据 → 分析变化 → 推送企业微信），验证用户能在企业微信群收到格式正确的报告。

**Acceptance Scenarios**:

1. **Given** 系统已配置企业微信 Webhook 且定时任务已启动  
   **When** 每天上午 11:00 到达（北京时间，可配置）  
   **Then** 用户在企业微信群收到当日 ARK 持仓报告，包含 5 只 ETF 的变化摘要

2. **Given** ARK 某只 ETF 有新增或移除股票  
   **When** 每日报告推送  
   **Then** 报告中清晰标注新增股票（✅ 标记）和移除股票（❌ 标记）

3. **Given** 某只股票持仓变化超过阈值（默认 ±5%）  
   **When** 每日报告推送  
   **Then** 报告中高亮显示该股票的变化幅度和权重调整

4. **Given** 今日所有 ETF 持仓无重大变化  
   **When** 每日报告推送  
   **Then** 报告显示 "今日无重大变化" 并附上前 5 大持仓列表

5. **Given** 用户在周末或节假日  
   **When** ARK 官网无数据更新  
   **Then** 系统不推送报告（避免噪音）

---

### User Story 2 - 识别重大持仓调整 (Priority: P1)

作为投资者，我希望系统自动识别并突出显示木头姐的重大持仓调整（如增持 >10% 或新建仓位），这样我可以第一时间关注她最看好的赛道和公司。

**Why this priority**: 木头姐每天会调整几十只股票，但只有少数是重大操作。用户需要快速定位关键信息，而非浏览完整列表。

**Independent Test**: 准备两份测试数据（前后两日持仓 CSV），模拟某股票增持 15%、某股票新建仓位、某股票减持 8%，验证系统能正确分类并按重要性排序。

**Acceptance Scenarios**:

1. **Given** ARKK 对特斯拉的持股数增加 12%  
   **When** 生成每日报告  
   **Then** 特斯拉被标注为 "显著增持"（📈 标记）并显示在 "持仓变化" 板块顶部

2. **Given** ARKG 新建仓位 Robinhood，权重 0.5%  
   **When** 生成每日报告  
   **Then** Robinhood 显示在 "新增持仓" 板块，附上公司名称和初始权重

3. **Given** ARKW 完全移除 Spotify 仓位  
   **When** 生成每日报告  
   **Then** Spotify 显示在 "移除持仓" 板块，附上之前的权重

4. **Given** 某股票持仓变化为 +3%（低于默认阈值 5%）  
   **When** 生成每日报告  
   **Then** 该股票不显示在 "持仓变化" 板块（仅在完整持仓列表中可见）

---

### User Story 3 - ARK 全系列基金汇总报告 (Priority: P1)

作为投资者，我希望能看到所有 ARK 基金的汇总分析，一眼了解 Wood 姐的整体投资布局和核心持仓，发现跨基金的重点股票。

**Why this priority**: 单个基金报告适合深入分析，但缺乏全局视角。汇总报告能快速发现：(1) 哪些股票是 Wood 姐最看好的（跨基金重叠）；(2) 各基金的投资重点差异；(3) 多基金同时增持/减持的信号。

**Independent Test**: 准备 5 个 ETF 的当日数据，验证系统能生成包含跨基金重叠分析、各基金对比、独家持仓的汇总报告，并生成长图推送到企业微信。

**Acceptance Scenarios**:

1. **Given** 系统已获取所有 5 只 ETF 的当日数据  
   **When** 生成汇总报告  
   **Then** 报告包含跨基金重叠 Top 10、各基金 Top 5 对比、独家持仓亮点

2. **Given** TSLA 同时出现在 ARKK、ARKW、ARKQ 三个基金中  
   **When** 分析跨基金重叠  
   **Then** TSLA 显示为 3 基金持仓，总权重为三者之和，并列出各基金分布

3. **Given** 某股票今日被 3 个基金同时增持  
   **When** 生成重点变化提示  
   **Then** 报告中突出显示"被 3 只基金同时增持"

4. **Given** ARKG 有权重 ≥3% 的独家持仓（其他基金未持有）  
   **When** 生成独家持仓亮点  
   **Then** 这些股票显示在 ARKG 独家持仓板块

5. **Given** 某个 ETF 下载失败  
   **When** 生成汇总报告  
   **Then** 如果成功基金 ≥2 个，仍生成汇总（标注失败基金）；如果 <2 个，跳过汇总

---

### User Story 4 - 持仓趋势可视化 (Priority: P1)

作为投资者，我希望能通过趋势图直观看到基金市值变化和 Top 10 个股持股数变化，快速判断 Wood 姐的调仓方向和力度。

**Why this priority**: 表格数据适合精确查询，但缺乏直观性。趋势图能快速回答：(1) 基金规模增长还是缩减？(2) 核心持仓是持续加仓还是减仓？(3) 新增股票后续表现如何？

**Independent Test**: 准备 30 天和 90 天的历史数据，验证系统能生成基金市值趋势、Top 10 个股持股数趋势（1个月+3个月）、新增持仓趋势、持仓变化柱状图。

**Acceptance Scenarios**:

1. **Given** 系统已累积 30 天以上历史数据  
   **When** 生成趋势图  
   **Then** 显示 1 个月基金市值趋势和 Top 10 个股持股数趋势

2. **Given** 系统已累积 90 天以上历史数据  
   **When** 生成趋势图  
   **Then** 显示 3 个月趋势图（在 1 个月图下方）

3. **Given** 历史数据不足 30 天  
   **When** 生成趋势图  
   **Then** 显示提示"历史数据累积中，X天后激活趋势图"

4. **Given** 某股票持股数从 100万 增加到 150万  
   **When** 显示趋势图  
   **Then** Y 轴格式化为 "1.0M" 和 "1.5M"，曲线上升

5. **Given** 今日有显著增持/减持（≥5%）  
   **When** 生成柱状图  
   **Then** 增持显示绿色柱，减持显示红色柱，按变化幅度排序

---

### User Story 5 - 手动查询历史数据 (Priority: P2)

作为投资者，我希望能够手动触发系统查询指定日期的持仓数据和变化分析，这样我可以在错过自动推送时补偿获取，或回溯分析历史调仓记录。

**Why this priority**: 虽然大部分场景是自动推送，但用户偶尔会遇到电脑关机、网络故障等导致错过推送，需要手动补偿机制。此外，回溯分析也是投资研究的常见需求。

**Independent Test**: 运行命令 `python ark_monitor.py --date 2025-01-15` 验证系统能下载指定日期数据、与前一日对比、并推送报告到企业微信。

**Acceptance Scenarios**:

1. **Given** 用户发现 1月15日 未收到自动推送  
   **When** 运行命令 `python ark_monitor.py --date 2025-01-15`  
   **Then** 系统下载 2025-01-15 的数据、对比 2025-01-14、生成报告并推送

2. **Given** 用户想分析木头姐在某特定日期的操作  
   **When** 运行命令 `python ark_monitor.py --date 2025-01-10`  
   **Then** 系统生成 2025-01-10 的持仓变化报告（即使当前日期已远超该日期）

3. **Given** 用户指定的日期尚无数据（未来日期或周末）  
   **When** 运行手动查询命令  
   **Then** 系统返回友好错误提示 "2025-01-20 暂无数据，ARK 官网尚未更新"

---

### User Story 6 - 容错与手动补偿 (Priority: P2)

作为投资者，我希望在电脑关机或网络故障导致错过推送时，开机后能通过简单命令手动补偿缺失的更新，这样我不会因偶然情况错过重要信息。

**Why this priority**: 本地部署架构下，电脑关机时无法执行定时任务。提供便捷的手动补偿机制能确保用户不错过关键持仓变化，同时保持系统简洁性（无需云函数）。

**Independent Test**: 
1. 关闭电脑 3 天，开机后运行 `python main.py --check-missed` 验证系统检测缺失日期并依次补偿
2. 模拟网络故障，验证重试机制（3次指数退避）

**Acceptance Scenarios**:

1. **Given** 用户电脑连续 3 天关机（如周末出差）  
   **When** 开机后运行 `python main.py --check-missed`  
   **Then** 系统检测最近 7 天的缺失日期，依次下载数据、分析并推送补偿报告

2. **Given** 用户开机后运行 `--check-missed`，发现已有所有数据  
   **When** 检测完成  
   **Then** 系统提示 "无缺失数据，所有报告已推送"

3. **Given** 网络请求 ARK 官网超时  
   **When** 第一次下载失败  
   **Then** 系统等待 1 秒后重试，最多重试 3 次（指数退避：1s, 2s, 4s）

4. **Given** 企业微信 Webhook 推送失败  
   **When** 第一次推送失败  
   **Then** 系统重试 3 次（每次间隔 5 秒），仍失败则保存报告到本地并记录错误日志

5. **Given** 单个 ETF（如 ARKK）下载失败  
   **When** 处理其他 ETF  
   **Then** 系统继续处理剩余 4 只 ETF，在报告中标注 ARKK 数据获取失败

---

### User Story 7 - 可配置的阈值与 ETF 列表 (Priority: P3)

作为投资者，我希望能自定义持仓变化阈值（如从默认 5% 调整为 3% 或 10%），并选择监控特定的 ETF 子集（如只关注 ARKK 和 ARKG），这样我可以根据个人偏好调整报告的详细程度。

**Why this priority**: 不同用户对信息密度的偏好不同。激进投资者可能希望捕捉所有 ±3% 的变化，而长线投资者可能只关注 ±10% 的重大调整。允许配置能提升用户满意度。

**Independent Test**: 修改 `.env` 文件设置 `CHANGE_THRESHOLD=3.0` 和 `ETFS=ARKK,ARKG`，运行系统验证报告仅包含 ARKK 和 ARKG，且显示 ±3% 以上的变化。

**Acceptance Scenarios**:

1. **Given** 用户在 `.env` 文件设置 `CHANGE_THRESHOLD=10.0`  
   **When** 生成每日报告  
   **Then** 只有持仓变化 ≥ ±10% 的股票显示在 "持仓变化" 板块

2. **Given** 用户设置 `ETFS=ARKK,ARKW` （仅监控 2 只 ETF）  
   **When** 系统执行每日任务  
   **Then** 仅下载和分析 ARKK、ARKW 数据，报告中不包含 ARKG、ARKQ、ARKF

3. **Given** 用户设置 `CHANGE_THRESHOLD=3.0`  
   **When** 某股票持仓变化为 +4%  
   **Then** 该股票显示在报告的 "持仓变化" 板块（之前默认 5% 阈值下不会显示）

---

### Edge Cases

- **数据源不可用**: ARK 官网维护或 URL 变更导致 CSV 下载失败  
  → 系统重试 3 次后发送告警到企业微信，提示用户手动介入

- **CSV 格式变更**: ARK 修改 CSV 文件列名或新增列  
  → 系统捕获解析异常，记录详细错误日志，跳过该 ETF 并在报告中标注

- **企业微信消息过长**: 某日变化过多导致报告超过 4096 字符限制  
  → 系统自动截断，优先保留摘要和 ARKK 数据，末尾提示 "详情查看日志文件"

- **时区问题**: 美东时间 19:00 更新数据对应北京时间次日 07:00-08:00（注意：美国夏令时期间时差为13小时，非夏令时为12小时）  
  → 系统默认在北京时间 11:00 执行（可通过配置文件调整），确保任何时区情况下数据已更新。偶尔延迟时，重试机制能兜底获取

- **节假日和周末**: ARK 在非交易日不更新数据  
  → 系统检测数据日期，如与前一日相同则跳过推送（避免重复）

- **首次运行无历史数据**: 第一天运行时无前一日数据用于对比  
  → 系统仅下载并保存当前数据，推送消息说明 "首次运行，明日开始对比分析"

- **同一天多次运行**: 用户在同一天多次手动触发任务  
  → 系统覆盖当日 CSV 文件，但检测已推送标记，询问用户是否强制重新推送

- **同一时间多次执行**: 用户在定时任务执行期间手动触发  
  → 通过本地状态文件 `data/cache/push_status.json` 实现幂等性，确保同一天仅推送一次

---

## Requirements *(mandatory)*

### Functional Requirements

**数据采集**:

- **FR-001**: 系统必须每日自动下载 ARK 旗下 5 只 ETF 的最新持仓 CSV 文件（ARKK、ARKW、ARKG、ARKQ、ARKF），使用 GitHub 镜像数据源：`https://raw.githubusercontent.com/thisjustinh/ark-invest-history/master/fund-holdings/{ETF}.csv`
- **FR-001-1**: 系统必须自动筛选 GitHub 历史数据中的最新日期记录（通过 `date` 列判断并过滤）
- **FR-002**: 系统必须将下载的数据保存到本地文件系统，文件命名格式为 `{ETF名称}/{YYYY-MM-DD}.csv`
- **FR-003**: 系统必须验证下载的 CSV 文件格式正确性（包含必需列：date, company, ticker, shares, market_value, weight）
- **FR-004**: 系统必须检测数据是否为最新（通过 DataFrame 中 `date` 列的最大值判断）
- **FR-005**: 系统必须在网络请求失败时实施重试机制（最多 3 次，指数退避：1s, 2s, 4s）
- **FR-005-1**: 系统必须在 HTTP 请求中添加 User-Agent 头避免 403 错误

**数据分析**:

- **FR-006**: 系统必须对比当前持仓与前一交易日持仓，识别以下变化：
  - 新增股票（之前未持有，现在持有）
  - 移除股票（之前持有，现在不持有）
  - 持仓数量变化超过阈值的股票（默认 ±5%，可配置）
- **FR-007**: 系统必须计算每只股票的持仓变化百分比（基于股数）
- **FR-008**: 系统必须计算每只股票的权重变化（以百分点为单位）
- **FR-009**: 系统必须识别每只 ETF 的前 10 大持仓（汇总报告）和前 5 大持仓（单基金报告）
- **FR-010**: 系统必须支持用户自定义持仓变化阈值（通过配置文件）
- **FR-011**: 系统必须分析跨基金重叠股票，计算总权重和出现基金数
- **FR-012**: 系统必须识别各基金的独家持仓（权重 ≥3% 且仅在单一基金中）
- **FR-013**: 系统必须检测多基金同时增持/减持的股票

**报告生成**:

- **FR-014**: 系统必须生成 Markdown 格式的每日持仓报告（单基金）和汇总报告
- **FR-015**: 单基金报告必须包含以下板块：
  1. 整体概况（持仓数、执行时间）
  2. 详细变化（新增、移除、持仓变化、前 5 大持仓）
  3. 免责声明和数据来源说明
- **FR-016**: 汇总报告必须包含以下板块：
  1. 统计摘要（5只基金对比表格）
  2. 跨基金重叠 Top 10
  3. 各基金 Top 5 持仓
  4. 独家持仓亮点
  5. 今日重点变化
- **FR-017**: 报告必须使用 emoji 图标标识不同操作类型（✅ 新增、❌ 移除、📈 增持、📉 减持）
- **FR-018**: 报告必须控制字符长度在 4096 以内（企业微信限制）
- **FR-019**: 当报告过长时，系统必须自动截断并提示用户查看日志文件

**趋势图生成**:

- **FR-020**: 系统必须生成长图报告，包含以下图表：
  1. 基金总市值趋势（1个月 + 3个月）
  2. Top 10 个股持股数趋势（1个月 + 3个月）
  3. 新增持仓股票趋势
  4. 持仓变化柱状图（显著增持/减持）
- **FR-021**: 趋势图 Y 轴必须格式化为 M/K 单位（如 1.2M, 345K）
- **FR-022**: 系统必须在历史数据不足 30 天时显示提示信息
- **FR-023**: 汇总报告长图必须额外包含跨基金重叠股票趋势图
- **FR-024**: 所有图表必须使用中文标签和图例

**通知推送**:

- **FR-025**: 系统必须通过企业微信群机器人 Webhook 推送报告
- **FR-026**: 系统必须支持 Markdown 格式消息推送和图片推送
- **FR-027**: 系统必须在推送失败时实施重试机制（最多 3 次，每次间隔 5 秒）
- **FR-028**: 系统必须在推送持续失败时保存报告到本地文件
- **FR-029**: 系统必须记录每次推送的成功/失败状态
- **FR-030**: 系统必须每日推送 6 条消息（1个汇总 + 5个单基金长图）
- **FR-031**: 汇总报告推送必须包含卡片式 Markdown + 长图

**调度控制**:

- **FR-032**: 系统必须支持定时自动执行（macOS Launchd，默认每天 19:00 北京时间）
- **FR-033**: 系统必须支持手动触发执行（命令行参数 `--manual`）
- **FR-034**: 系统必须支持指定日期查询（命令行参数 `--date YYYY-MM-DD`）
- **FR-035**: 系统必须支持检测并补偿错过的更新（命令行参数 `--check-missed`）
- **FR-036**: 系统必须支持测试企业微信 Webhook 连接（命令行参数 `--test-webhook`）
- **FR-037**: 系统必须防止同一天重复推送（通过状态标记文件 `data/cache/push_status.json`）
- **FR-038**: 系统必须支持跳过汇总报告（命令行参数 `--skip-summary`）
- **FR-039**: 系统必须支持跳过推送（命令行参数 `--skip-notification`）
- **FR-040**: 系统必须支持补充历史数据（命令行参数 `--backfill --days N`）

**容错机制**:

- **FR-041**: 系统必须在单个 ETF 失败时继续处理其他 ETF（部分成功策略）
- **FR-042**: 系统必须记录所有错误到日志文件，包含时间戳、ETF 名称、错误详情
- **FR-043**: 系统必须在网络故障时自动重试（最多 3 次，指数退避：1s, 2s, 4s）
- **FR-044**: 系统必须在推送失败时保存报告到本地文件（`data/reports/failed/{YYYY-MM-DD}.md`）
- **FR-045**: 汇总报告最少需要 2 个成功 ETF 才生成，否则跳过汇总

**配置管理**:

- **FR-046**: 系统必须通过 `config.yaml` 配置文件管理所有非敏感配置，通过 `.env` 文件管理敏感配置（Webhook URL）
- **FR-047**: 系统必须支持以下可配置项：
  - **定时任务**: 执行时间（默认 19:00）、时区（默认 Asia/Shanghai）
  - **数据源**: 监控的 ETF 列表（默认 ARKK,ARKW,ARKG,ARKQ,ARKF）
  - **存储**: 数据目录（默认 `./data`）、日志目录（默认 `./logs`）、图片目录（默认 `./data/images`）
  - **分析**: 持仓变化阈值（默认 5.0%）、独家持仓权重阈值（默认 3.0%）
  - **通知**: Webhook URL（从 `.env` 读取）、错误告警开关、是否跳过汇总
  - **重试**: 重试次数（默认 3）、重试延迟（默认 [1,2,4] 秒）
  - **日志**: 保留天数（默认 30）、日志级别（默认 INFO）
  - **趋势图**: 1个月天数（默认 30）、3个月天数（默认 90）
- **FR-048**: 系统必须在启动时验证必需配置项（Webhook URL），缺失则终止并提示用户
- **FR-049**: 配置文件修改后必须立即生效，无需重启程序（下次执行时自动加载）

**日志与监控**:

- **FR-050**: 系统必须记录所有关键操作到日志文件（下载、分析、生成图片、推送）
- **FR-051**: 日志必须包含时间戳、日志级别、模块名称、操作详情
- **FR-052**: 系统必须按日期分割日志文件（格式：`wood_ark.log`）
- **FR-053**: 系统必须根据配置保留指定天数的日志文件，自动清理过期日志（默认 30 天）
- **FR-054**: 系统必须在严重错误时发送告警到企业微信（可选，通过配置开关控制）

### Key Entities

- **ETF 持仓数据**：代表某只 ARK ETF 在特定日期的完整持仓列表
  - 包含字段：日期、基金代码、公司名称、股票代码、持股数量、市值、权重
  - 存储格式：CSV 文件
  - 命名规则：`{ETF}/{YYYY-MM-DD}.csv`

- **持仓变化记录**：代表前后两个交易日之间的持仓差异
  - 包含信息：新增股票列表、移除股票列表、变化股票列表（含变化幅度）
  - 存储格式：内存中的字典结构（不持久化）
  - 用途：生成每日报告

- **每日报告**：代表发送给用户的 Markdown 格式持仓分析报告
  - 包含板块：整体摘要、分 ETF 详情、免责声明
  - 格式：Markdown 文本
  - 输出渠道：企业微信 Webhook + 本地日志文件

- **推送状态标记**：代表某日是否已成功推送报告
  - 包含字段：日期、推送时间、推送方式（本地/云函数）
  - 存储格式：JSON 文件（`data/cache/push_status.json`）
  - 用途：防止重复推送

- **配置信息**：代表系统运行所需的所有配置参数
  - 包含字段：定时任务设置、数据源配置、分析参数、通知配置、重试策略、日志配置
  - 存储格式：`config.yaml`（非敏感配置）+ `.env`（敏感配置）
  - 加载时机：每次程序执行时（支持热更新）
  - 示例配置：见规范 "Clarifications" 章节

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

**用户体验**:

- **SC-001**: 用户每天 11:05 前能在企业微信群收到当日持仓报告（电脑开机情况下 99% 成功率）
- **SC-002**: 用户能在 30 秒内扫描报告并识别关键持仓变化（无需滚动超过 2 屏）
- **SC-003**: 用户手动触发查询能在 1 分钟内完成执行并收到报告
- **SC-004**: 用户错过的推送能通过运行 `--check-missed` 命令在 5 分钟内恢复（补偿最近 7 天）

**系统性能**:

- **SC-005**: 单次完整任务执行（5 只 ETF 下载 + 分析 + 推送）在 60 秒内完成
- **SC-006**: 单个 ETF 数据下载在 30 秒内完成（正常网络条件下 <5 秒）
- **SC-007**: `--check-missed` 命令补偿 7 天缺失数据在 5 分钟内完成
- **SC-008**: 网络故障重试机制能在 10 秒内完成 3 次重试（1s + 2s + 4s 退避）

**可靠性**:

- **SC-009**: 系统月度推送成功率达到 95% 以上（电脑开机情况下，30 天中最多 1-2 次失败）
- **SC-010**: 单个 ETF 下载失败不影响其他 4 只 ETF 的正常处理和推送
- **SC-011**: `--check-missed` 命令能 100% 准确检测最近 7 天的缺失日期
- **SC-012**: 所有错误场景都能生成详细日志并发送告警（可选，通过配置控制）

**数据准确性**:

- **SC-013**: 持仓变化计算与手工验证结果 100% 一致（无计算错误）
- **SC-014**: 新增/移除股票识别准确率 100%（无漏报和误报）
- **SC-015**: 前 5 大持仓排序准确率 100%（按权重降序）

**可维护性**:

- **SC-016**: 新增监控一只 ETF 仅需修改 `config.yaml`，无需改代码（耗时 <1 分钟）
- **SC-017**: 调整任何配置参数（阈值、定时时间等）仅需修改 `config.yaml`，下次执行立即生效
- **SC-018**: 所有关键操作都有详细日志，故障排查平均耗时 <10 分钟
- **SC-019**: 系统能在 30 天内无人工干预稳定运行（自动清理日志），仅需定期运行 `--check-missed` 补偿关机期间的缺失

**资源效率**:

- **SC-020**: 系统本地存储占用每年 <100MB（30 天日志 + 365 天持仓数据）
- **SC-021**: 单次执行内存占用 <128MB（可在 1GB 内存环境运行）
- **SC-022**: CPU 占用峰值 <10%（5 秒内完成数据处理）

---

## Assumptions *(mandatory)*

1. **数据更新时间**: 假设 ARK Invest 在美东时间每日 19:00 更新持仓数据。由于美国夏令时影响，对应北京时间为次日 07:00（夏令时3-11月）或 08:00（非夏令时）。系统默认在北京时间 11:00 执行，确保任何情况下数据已更新
2. **网络环境**: 假设用户网络能正常访问 ARK 官网（ark-funds.com）和企业微信 API
3. **企业微信权限**: 假设用户已创建企业微信群并添加了群机器人，拥有有效的 Webhook URL
4. **运行环境**: 假设用户本地环境为 macOS，Python 3.9+，支持 cron 定时任务
5. **数据格式**: 假设 ARK 官方 CSV 文件格式保持稳定（列名：company, ticker, shares, market value, weight）
6. **历史数据**: 假设用户在首次运行时能接受无对比分析（需第二天才能生成变化报告）
7. **时区设置**: 假设用户本地时区设置为 UTC+8（北京时间）
8. **存储权限**: 假设用户对数据目录（`data/`）和日志目录（`logs/`）有读写权限
9. **电脑开机**: 假设用户工作日期间电脑保持开机状态，或定期运行 `--check-missed` 补偿关机期间的缺失
10. **推送频率**: 假设用户能接受每天最多推送 1 次报告（重复运行仅覆盖本地数据，不重复推送）

---

## Out of Scope *(optional)*

以下功能**不在**本期开发范围，可作为未来增强版考虑：

- ❌ **云函数备份**: 不使用腾讯云 SCF/AWS Lambda 等云服务（仅本地部署）
- ❌ **Docker 容器化**: 不提供 Docker 镜像（仅原生 Python 运行）
- ❌ **持仓可视化**: 生成持仓变化趋势图、权重分布饼图等可视化图表
- ❌ **邮件通知**: 除企业微信外的其他通知渠道（如邮件、Telegram、钉钉）
- ❌ **Web 界面**: 基于浏览器的 Dashboard 或管理后台
- ❌ **多用户支持**: 不同用户订阅不同 ETF 组合或自定义阈值
- ❌ **数据库存储**: 使用 MySQL/PostgreSQL 替代 CSV 文件存储
- ❌ **实时推送**: ARK 数据更新后立即推送（而非定时推送）
- ❌ **持仓回测**: 基于历史数据分析木头姐的选股胜率、板块配置等
- ❌ **交易提醒**: 根据木头姐的操作自动生成交易建议
- ❌ **移动端 APP**: iOS/Android 原生应用
- ❌ **语音播报**: 通过智能音箱播报每日持仓变化

---

## Clarifications

### Session 2025-11-13

- Q: ARK CSV 数据的准确来源与发现机制？ → A: 使用 GitHub 镜像 `https://raw.githubusercontent.com/thisjustinh/ark-invest-history/master/fund-holdings/{ETF}.csv`（ARK 官网存在反爬虫保护）
- Q: 如何处理 GitHub 历史数据？ → A: 自动筛选 `date` 列的最大值，仅保留最新日期的记录
- Q: 时区处理策略与夏令时影响？ → A: 固定北京时间执行（默认 11:00，可配置），忽略美国夏令时影响，依赖重试机制兜底
- Q: 幂等性保证的实现机制？ → A: 使用纯本地状态文件 `data/cache/push_status.json`，无需云端同步
- Q: 是否需要云函数备份？ → A: 不需要。系统仅支持本地 Python + cron 部署，关机错过推送时通过 `--check-missed` 手动补偿
- Q: 定时任务执行时间？ → A: 默认北京时间 11:00（通过配置文件可调整）
- Q: 如何避免 403 错误？ → A: HTTP 请求添加标准 User-Agent 头

#### 配置文件示例 (config.yaml)

```yaml
# 定时任务配置
schedule:
  enabled: true           # 是否启用定时任务
  cron_time: "11:00"      # 执行时间（24小时制）
  timezone: "Asia/Shanghai"  # 时区

# 数据源配置
data:
  etfs: ["ARKK", "ARKW", "ARKG", "ARKQ", "ARKF"]  # 监控的 ETF 列表
  data_dir: "./data"      # 数据存储目录
  log_dir: "./logs"       # 日志存储目录

# 分析参数
analysis:
  change_threshold: 5.0   # 持仓变化阈值（百分比）

# 通知配置
notification:
  webhook_url: "${WECHAT_WEBHOOK_URL}"  # 从 .env 读取
  enable_error_alert: true  # 是否发送错误告警

# 重试策略
retry:
  max_retries: 3          # 最大重试次数
  retry_delays: [1, 2, 4] # 重试延迟（秒）

# 日志配置
log:
  retention_days: 30      # 日志保留天数
  level: "INFO"           # 日志级别: DEBUG, INFO, WARNING, ERROR
```

#### 环境变量文件示例 (.env)

```bash
# 企业微信 Webhook URL（必填）
WECHAT_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-key-here
```

---

## Dependencies *(optional)*

- **外部数据源**: GitHub 镜像仓库（thisjustinh/ark-invest-history）- 公开 CSV 数据，无需认证
  - **URL 格式**: `https://raw.githubusercontent.com/thisjustinh/ark-invest-history/master/fund-holdings/{ETF}.csv`
  - **支持的 ETF**: ARKK, ARKW, ARKG, ARKQ, ARKF
  - **更新时间**: 美东时间每日 19:00（北京时间次日 07:00-08:00）
  - **数据特点**: 包含完整历史数据，需自动筛选最新日期
  - **选择理由**: ARK 官网反爬虫机制导致 403/404 错误，GitHub 镜像更稳定
- **备用数据源（暂不实现）**: ARK Invest 官网 - 存在反爬虫保护，后续可实现双源切换
- **通知服务**: 企业微信群机器人 Webhook API - 需用户提供有效 URL
- **运行环境**: Python 3.9+ 环境，macOS 操作系统，cron 定时任务
- **配置文件**: YAML 解析库（PyYAML）- 用于读取 `config.yaml`

---

## Notes *(optional)*

### 为什么选择本地优先架构？

- **隐私性**: 持仓数据虽为公开信息，但用户的监控偏好（阈值、ETF 列表）属于个人隐私
- **成本**: 本地运行零成本，云函数仅作备份，月成本 <¥1
- **可控性**: 用户完全掌控数据和配置，无需依赖第三方服务稳定性

### 为什么选择企业微信而非个人微信？

- 个人微信无官方机器人 API（非官方方案违反 ToS 且不稳定）
- 企业微信群机器人免费、稳定、官方支持 Markdown 渲染
- 企业微信支持个人注册（无需企业资质）

### 为什么使用 CSV 而非数据库？

- ARK 每日数据量小（每只 ETF <50 只股票，5 只 ETF 共 <250 条记录）
- CSV 文件直观、便于手工查看、便于迁移和备份
- 无需数据库维护成本（安装、备份、性能优化）
- pandas 库处理 CSV 性能充足（秒级加载和分析）

### 为什么默认阈值设为 5%？

- 低于 5% 的持仓变化通常为再平衡操作，非主动调仓
- 5% 阈值能过滤噪音，突出木头姐的真实投资意图
- 用户可根据偏好调整（激进投资者可设为 3%，长线投资者可设为 10%）

---

## Risk Assessment *(optional)*

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| ARK 官网 URL 变更 | 中 | 高 | 通过配置文件支持自定义 URL；监控下载失败告警 |
| CSV 格式变更 | 低 | 高 | 增加格式校验；保留旧版解析兼容；发送告警 |
| 企业微信 API 限流 | 低 | 中 | 控制推送频率（每天 1 次）；失败时本地保存 |
| 电脑长期关机 | 中 | 中 | 提供 `--check-missed` 补偿命令；文档提醒定期运行 |
| 本地磁盘空间不足 | 低 | 中 | 自动清理过期日志；CSV 文件占用极小 |
| 时区错乱导致误触发 | 低 | 中 | 通过配置文件明确时区；增加时区检测 |
| 节假日重复推送 | 低 | 低 | 检测数据日期，相同则跳过推送 |

---

**Specification Status**: ✅ Ready for `/speckit.plan`

**Next Steps**:
1. 如有疑问，运行 `/speckit.clarify` 进行需求澄清
2. 确认无误后，运行 `/speckit.plan` 制定技术方案
