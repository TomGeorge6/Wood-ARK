#!/usr/bin/env python3
"""
æ•°æ®å®Œæ•´æ€§æ£€æŸ¥è„šæœ¬

æ£€æŸ¥å†å²æ•°æ®æ˜¯å¦å®Œæ•´ï¼Œè¯†åˆ«ç¼ºå¤±çš„æ—¥æœŸ
"""

import os
import sys
from datetime import datetime, timedelta
from pathlib import Path
from zoneinfo import ZoneInfo

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from src.utils import load_config


def check_data_integrity(etf_symbol: str, days: int = 30):
    """
    æ£€æŸ¥æŒ‡å®š ETF çš„æ•°æ®å®Œæ•´æ€§
    
    Args:
        etf_symbol: ETF ä»£ç 
        days: æ£€æŸ¥æœ€è¿‘å¤šå°‘å¤©
    """
    config = load_config()
    data_dir = Path(config.data.data_dir) / 'holdings' / etf_symbol
    
    if not data_dir.exists():
        print(f"âŒ {etf_symbol} æ•°æ®ç›®å½•ä¸å­˜åœ¨: {data_dir}")
        return
    
    # è·å–ç°æœ‰æ–‡ä»¶
    csv_files = sorted([f.stem for f in data_dir.glob('*.csv')])
    
    print(f"\n{'='*60}")
    print(f"ğŸ“Š {etf_symbol} æ•°æ®å®Œæ•´æ€§æ£€æŸ¥")
    print(f"{'='*60}")
    print(f"æ•°æ®ç›®å½•: {data_dir}")
    print(f"æ–‡ä»¶æ€»æ•°: {len(csv_files)} ä¸ª")
    
    if csv_files:
        print(f"æœ€æ—©æ—¥æœŸ: {csv_files[0]}")
        print(f"æœ€æ–°æ—¥æœŸ: {csv_files[-1]}")
    else:
        print("âŒ æ²¡æœ‰ä»»ä½•æ•°æ®æ–‡ä»¶ï¼")
        return
    
    # æ£€æŸ¥æœ€è¿‘ N å¤©çš„ç¼ºå¤±æ—¥æœŸ
    et_tz = ZoneInfo("America/New_York")
    today = datetime.now(et_tz).date()
    
    expected_dates = []
    for i in range(days):
        check_date = today - timedelta(days=i)
        # åªæ£€æŸ¥å·¥ä½œæ—¥ï¼ˆå‘¨ä¸€åˆ°å‘¨äº”ï¼‰
        if check_date.weekday() < 5:
            expected_dates.append(check_date.strftime('%Y-%m-%d'))
    
    expected_dates.reverse()
    
    # æ‰¾å‡ºç¼ºå¤±çš„æ—¥æœŸ
    missing_dates = [d for d in expected_dates if d not in csv_files]
    
    print(f"\næ£€æŸ¥èŒƒå›´: æœ€è¿‘ {days} å¤©ï¼ˆä»…å·¥ä½œæ—¥ï¼‰")
    print(f"åº”æœ‰æ•°æ®: {len(expected_dates)} ä¸ªäº¤æ˜“æ—¥")
    print(f"å®é™…æ‹¥æœ‰: {len([d for d in expected_dates if d in csv_files])} ä¸ª")
    
    if missing_dates:
        print(f"\nâš ï¸  ç¼ºå¤±æ—¥æœŸ ({len(missing_dates)} ä¸ª):")
        for date in missing_dates:
            # æ£€æŸ¥æ˜¯å¦æ˜¯èŠ‚å‡æ—¥ï¼ˆç®€å•åˆ¤æ–­ï¼‰
            date_obj = datetime.strptime(date, '%Y-%m-%d')
            weekday = date_obj.strftime('%A')
            print(f"  - {date} ({weekday})")
        
        print(f"\nğŸ’¡ è¡¥å……ç¼ºå¤±æ•°æ®:")
        print(f"python3 main.py --date YYYY-MM-DD --manual")
    else:
        print(f"\nâœ… æ•°æ®å®Œæ•´ï¼")
    
    # æ£€æŸ¥æ–‡ä»¶å¤§å°å¼‚å¸¸
    print(f"\n{'='*60}")
    print("ğŸ“ æ–‡ä»¶å¤§å°æ£€æŸ¥")
    print(f"{'='*60}")
    
    file_sizes = []
    for csv_file in sorted(data_dir.glob('*.csv'))[-10:]:  # æ£€æŸ¥æœ€è¿‘10ä¸ªæ–‡ä»¶
        size = csv_file.stat().st_size
        file_sizes.append((csv_file.name, size))
    
    if file_sizes:
        avg_size = sum(s for _, s in file_sizes) / len(file_sizes)
        
        for filename, size in file_sizes:
            status = "âœ…"
            if size < avg_size * 0.5:  # å°äºå¹³å‡å€¼çš„50%
                status = "âš ï¸  (åå°)"
            elif size > avg_size * 2:  # å¤§äºå¹³å‡å€¼çš„200%
                status = "âš ï¸  (åå¤§)"
            
            print(f"{status} {filename}: {size:,} bytes")
        
        print(f"\nå¹³å‡æ–‡ä»¶å¤§å°: {avg_size:,.0f} bytes")


def check_all_etfs(days: int = 30):
    """æ£€æŸ¥æ‰€æœ‰ ETF çš„æ•°æ®å®Œæ•´æ€§"""
    etfs = ['ARKK', 'ARKW', 'ARKG', 'ARKQ', 'ARKF']
    
    for etf in etfs:
        check_data_integrity(etf, days)
    
    print(f"\n{'='*60}")
    print("âœ… æ£€æŸ¥å®Œæˆ")
    print(f"{'='*60}\n")


if __name__ == '__main__':
    import argparse
    
    parser = argparse.ArgumentParser(description='æ£€æŸ¥ ARK ETF æ•°æ®å®Œæ•´æ€§')
    parser.add_argument('--etf', type=str, help='æŒ‡å®š ETF ä»£ç ï¼ˆä¸æŒ‡å®šåˆ™æ£€æŸ¥å…¨éƒ¨ï¼‰')
    parser.add_argument('--days', type=int, default=30, help='æ£€æŸ¥æœ€è¿‘å¤šå°‘å¤©ï¼ˆé»˜è®¤30å¤©ï¼‰')
    
    args = parser.parse_args()
    
    if args.etf:
        check_data_integrity(args.etf.upper(), args.days)
    else:
        check_all_etfs(args.days)
