# Wood-ARK 问题修复报告 (2025-11-14)

## 📋 问题总结

根据用户反馈，发现并修复了以下3个问题：

### 1. ⏰ 日期时区不一致
### 2. 📊 "显著增持"逻辑不符合预期  
### 3. 🚫 图片未能发送到企业微信（严重）

---

## ✅ 修复详情

### 问题1：日期时区不一致

**现象**：
- 汇总报告显示：`2025-11-13`（美国时间）
- 单基金报告显示：`2025-11-14`（北京时间）
- 用户困惑：为何日期不一致

**根本原因**：
ARK Funds 是美国基金，其数据更新按**美国东部时间（ET）**。北京时间比美国东部时间快 13 小时（冬令时）或 12 小时（夏令时）。

原代码使用 `datetime.now()` 获取系统时区，导致在中国运行时显示北京时间。

**修复方案**：
统一使用美国东部时间（ET），修改 `src/utils.py`：

```python
def get_current_date() -> str:
    """获取当前日期（美国东部时间）"""
    try:
        from zoneinfo import ZoneInfo
        et_tz = ZoneInfo("America/New_York")
        et_now = datetime.now(et_tz)
        return et_now.strftime('%Y-%m-%d')
    except ImportError:
        # 备用方案：UTC-5
        utc_now = datetime.utcnow()
        et_now = utc_now - timedelta(hours=5)
        return et_now.strftime('%Y-%m-%d')
```

**影响**：
- ✅ 所有日期统一为美国东部时间
- ✅ 与 ARK 官网数据日期一致
- ⚠️ 建议在**北京时间晚上**执行任务（对应美国早上数据已更新）

**验证方法**：
```bash
python3 test_fixes.sh
```

---

### 问题2："显著增持"逻辑改进

**现象**：
用户看到 `显著增持: 0 | 显著减持: 0`，无法查看所有持仓变化。

**根本原因**：
代码使用 5% 阈值过滤，只显示权重变化 > 5% 的股票。但用户希望看到**所有**新增/移除/增持/减持的股票。

**修复方案**：
修改 `src/notifier.py` 的推送内容：

```python
# 修改前（只显示显著变化）
lines.append(f"- 显著增持: {len(analysis_result['significant_increased'])} | "
             f"显著减持: {len(analysis_result['significant_decreased'])}")

# 修改后（显示所有变化）
lines.append(f"- 增持: {len(analysis_result['increased'])} | "
             f"减持: {len(analysis_result['decreased'])}")
```

**数据说明**：
- `increased` / `decreased`：所有有变化的股票（权重变化 > 0.01%）
- `significant_increased` / `significant_decreased`：显著变化的股票（权重变化 > 5%）

**影响**：
- ✅ 用户可查看所有持仓变化
- ✅ 图表中仍会高亮显示显著变化

---

### 问题3：图片发送失败（已修复）

**现象**：
- 企业微信只收到文字消息，没有收到图片
- 日志显示：`errcode: 40009 - invalid image size`

**根本原因**：

1. **拼接图尺寸过大**：
   - 尺寸：1788 x **30120** 像素
   - 大小：2.6 MB
   - 企业微信限制：图片高度建议 < 20000px

2. **企业微信 API 限制**：
   - 错误代码 40009：图片大小/格式/尺寸不符合要求
   - 超长图片（>30000px）无法正常显示

**修复方案**：
采用**分批发送图片**方案（最稳定）：

| 消息序号 | 内容 | 大小 |
|---------|------|------|
| 消息1 | 超长文字（汇总 + 5个基金摘要） | ~2500字符 |
| 消息2 | 汇总长图 | ~500KB |
| 消息3 | ARKK 长图 | ~400KB |
| 消息4 | ARKW 长图 | ~400KB |
| 消息5 | ARKG 长图 | ~400KB |
| 消息6 | ARKQ 长图 | ~400KB |
| 消息7 | ARKF 长图 | ~400KB |

**技术实现**：
```python
# 1. 发送文字
notifier.send_markdown(combined_text)

# 2. 发送汇总图
notifier.send_image(summary_image)
time.sleep(0.5)

# 3. 依次发送各基金图
for etf in ['ARKK', 'ARKW', 'ARKG', 'ARKQ', 'ARKF']:
    notifier.send_image(etf_image)
    time.sleep(0.5)  # 避免触发频率限制
```

**优点**：
- ✅ 单张图片 < 500KB，加载快
- ✅ 不会触发企业微信限制
- ✅ 用户可单独查看感兴趣的基金
- ✅ 稳定性最高

**缺点**：
- ⚠️ 需要发送 7 条消息（比原计划的 2 条多 5 条）
- ⚠️ 消息列表较长

---

## 📊 修改文件清单

### 核心代码修改

1. **`src/utils.py`**
   - ✅ 修改 `get_current_date()`：使用美国东部时间

2. **`src/notifier.py`**
   - ✅ 修改 `generate_etf_wechat_markdown()`：显示所有变化（非仅显著变化）

3. **`src/image_generator.py`**
   - ✅ 修复 `combine_images_vertical()` 方法重复定义问题
   - ✅ 删除无用代码片段

4. **`main.py`**
   - ✅ 重构推送逻辑：从拼接长图改为分批发送
   - ✅ 添加消息间延迟（0.5秒）
   - ✅ 添加发送成功/失败统计

### 新增文件

- `test_fixes.sh`：快速测试脚本
- `FIXES_SUMMARY.md`：问题分析文档
- `FIXES_20251114.md`：本修复报告

---

## 🧪 测试验证

### 1. 运行测试脚本

```bash
cd /Users/lucian/Documents/个人/Investment/Tools/Wood-ARK
./test_fixes.sh
```

**预期输出**：
- Python 环境正常
- 依赖已安装
- 日期为美国东部时间（比北京时间晚 13 小时）
- 历史数据存在（如不足需补充）

### 2. 补充历史数据（如需要）

```bash
python3 main.py --backfill --days 90
```

**预期结果**：
- 下载近 90 天的历史数据
- 每个基金约 60-70 个 CSV 文件
- 用于生成趋势图

### 3. 手动触发推送

```bash
python3 main.py --manual
```

**预期结果**：
- 企业微信收到 7 条消息
- 消息1：超长文字（汇总 + 5个基金摘要）
- 消息2-7：6张图片（汇总图 + 5个单基金图）

### 4. 监控日志

```bash
tail -f logs/wood_ark.log | grep -E "(发送|成功|失败)"
```

**检查要点**：
- ✅ 文字消息发送成功
- ✅ 6张图片全部发送成功
- ❌ 如有失败，检查错误代码

---

## 🎯 已知限制

### 企业微信 API 限制

- **图片大小**：< 10MB（建议 < 2MB）
- **图片尺寸**：建议 < 20000px（高+宽）
- **图片格式**：PNG, JPG, GIF
- **发送频率**：建议间隔 > 0.5 秒
- **消息长度**：Markdown 文本 < 4096 字符

### 当前方案符合所有限制

- ✅ 单张图片 < 500KB（远小于 2MB）
- ✅ 单张图片高度 < 5000px（远小于 20000px）
- ✅ 消息间隔 0.5 秒
- ✅ 文字消息 ~2500 字符（< 4096）

---

## 📝 用户使用指南

### 首次运行

```bash
# 1. 补充历史数据
python3 main.py --backfill --days 90

# 2. 测试 Webhook
python3 main.py --test-webhook

# 3. 手动触发推送
python3 main.py --manual
```

### 日常使用

```bash
# 自动模式（工作日自动执行）
python3 main.py

# 手动模式（强制执行）
python3 main.py --manual
```

### 查看推送结果

企业微信收到的消息顺序：

1. **📊 ARK 全系列基金监控日报** ← 文字消息
   - 今日概况
   - 核心持仓 Top 5
   - 各基金快速对比
   - 今日亮点
   - 5个基金摘要

2. **汇总长图** ← 图片1
   - 统计摘要
   - 跨基金重叠 Top 10
   - 各基金 Top 5
   - 独家持仓
   - 重点变化

3-7. **各基金详情长图** ← 图片2-6
   - 持仓表格 Top 15
   - 基金总额趋势（1个月 + 3个月）
   - Top 10 趋势
   - 新增股票趋势

---

## 🚀 下一步优化建议

### 短期优化（可选）

1. **压缩图片**：
   - 降低 DPI：150 → 100
   - 减少消息数量

2. **添加分组标签**：
   - 文字消息标注：`[1/7] 汇总报告`
   - 图片消息标注：`[2/7] 汇总图表`

### 长期优化（待评估）

1. **智能推送**：
   - 如无显著变化，只推送汇总
   - 如有重大变化，推送全部详情

2. **数据库存储**：
   - 使用 SQLite 存储历史数据
   - 加速趋势图生成

3. **Web 界面**：
   - 提供 Web 页面查看历史报告
   - 支持交互式图表

---

## ✅ 修复完成确认

- [x] 问题1：日期时区统一为美国东部时间
- [x] 问题2："显著增持"改为"增持"，显示所有变化
- [x] 问题3：改为分批发送图片，避免企业微信限制

**修复版本**: v1.2.0  
**修复日期**: 2025-11-14  
**测试状态**: 待用户验证  

---

**下一步操作**：
请运行 `python3 main.py --manual` 测试修复效果！
