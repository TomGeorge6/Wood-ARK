# 历史数据问题说明

## 问题根源

### 1. GitHub 历史数据源已过时
- ARK Invest 的 GitHub 历史镜像仓库 (thisjustinh/ark-invest-history) 
- **最后更新日期**: 2021-09-08
- **无法获取**: 2021年9月之后的历史数据

### 2. CSV 格式错误导致数据无法解析
- **问题**: `pandas.to_csv()` 未显式指定 `sep=','` 参数
- **结果**: 保存的 CSV 文件没有逗号分隔符
- **影响**: `pd.read_csv()` 无法正确解析，趋势图显示异常

### 3. 之前的"历史数据"
- **来源**: GitHub 下载的 2021 年旧数据
- **问题**: 格式错误（无逗号分隔符）+ 数据过时（3年前）
- **状态**: 已在修复过程中删除并重建

## 修复方案

### ✅ 已完成修复

1. **CSV 保存修复** (`src/fetcher.py`)
   ```python
   df.to_csv(file_path, index=False, encoding='utf-8', sep=',')
   ```

2. **CSV 读取修复** (`src/fetcher.py`)
   - 智能检测分隔符（Tab/逗号/空格）
   - 兼容不同格式的数据源

3. **显示修复**
   - Top 3 → Top 10
   - 权重趋势 → 持股数趋势

### 🔄 历史数据积累策略

**因为无法获取真实历史数据，我们采用"逐日累积"策略**：

1. **每天定时运行** (通过 cron)
   ```bash
   # 每个交易日下午 7 点运行（美东时间收盘后）
   0 19 * * 1-5 cd /path/to/Wood-ARK && python3 main.py
   ```

2. **手动补充缺失日期**
   ```bash
   # 如果某天缺少数据，可以手动下载当天的最新数据
   python3 main.py --manual
   ```

3. **数据保留策略**
   - 默认保留 90 天历史数据
   - 可通过配置调整 `retention_days`

### 📊 趋势图数据要求

- **1个月趋势**: 需要至少 30 天数据
- **3个月趋势**: 需要至少 90 天数据
- **当前状态**: 只有今天的数据，趋势图暂时无法正常显示

## 下一步行动

### 方案 A：等待自然累积（推荐）
- **优点**: 数据真实可靠
- **缺点**: 需要等待 30-90 天
- **操作**: 每天定时运行，自动积累历史数据

### 方案 B：使用替代数据源（需要开发）
- Yahoo Finance API
- Alpha Vantage API
- 需要额外开发适配代码

### 方案 C：接受当前限制
- 只显示当日持仓变化
- 暂时不显示趋势图
- 等待数据累积后自动激活趋势功能

## 当前推荐

**使用方案 A + 方案 C 组合**：
1. 立即部署定时任务，开始累积数据
2. 当前只使用"持仓变化分析"功能（对比前一交易日）
3. 30-90 天后，趋势图功能自动可用

---

**更新日期**: 2025-11-14  
**问题状态**: ✅ 已理解并制定解决方案
