# Wood-ARK 修复记录 (2025-11-14 v2)

## 修复的问题

### 问题1: Top 3 改为 Top 10
**位置**: 汇总报告的各基金对比部分

**修改文件**: `src/summary_notifier.py`

**修改内容**:
```python
# 修改前
top_holdings = summary['top_holdings'][:3]
lines.append(f"Top 3: {top3_str}")

# 修改后
top_holdings = summary['top_holdings'][:10]
lines.append(f"Top 10: {top10_str}")
```

**影响范围**: 企业微信推送的汇总报告文字部分，现在显示每个基金的 Top 10 持仓（而非 Top 3）

---

### 问题2: 补充 ARKK 历史数据
**问题描述**: ARKK 基金的历史数据为0，导致趋势图无法显示

**解决方案**: 执行历史数据补充命令
```bash
python3 main.py --backfill --days 90
```

**执行结果**:
- ✅ 成功下载近90天的历史数据
- 总计新增 **65 个文件**（ARKK、ARKW、ARKG、ARKQ、ARKF）
- ARKK 历史数据已补充完整

**验证方法**: 
- 检查 `data/holdings/ARKK/` 目录，应该有多个日期的CSV文件
- 长图中 ARKK 的趋势图应正常显示

---

### 问题3: 权重趋势改为持股数趋势
**位置**: 单基金详细报告长图的趋势图部分

**修改文件**: `src/image_generator.py`

**修改内容**:

#### 3.1 修改 Top 10 个股趋势图
```python
# 修改前
stock_weights_1m = {ticker: [] for ticker in current_top10}
weight = row.iloc[0]['weight'] if len(row) > 0 else 0
ax1.set_title(f'{etf_symbol} Top 10 个股权重趋势 - 最近 1 个月')
ax1.set_ylabel('权重 (%)', fontsize=10)

# 修改后
stock_shares_1m = {ticker: [] for ticker in current_top10}
shares = row.iloc[0]['shares'] if len(row) > 0 else 0
ax1.set_title(f'{etf_symbol} Top 10 个股持股数趋势 - 最近 1 个月')
ax1.set_ylabel('持股数', fontsize=10)
# 格式化Y轴（显示为M或K）
ax1.yaxis.set_major_formatter(plt.FuncFormatter(
    lambda x, p: f'{x/1e6:.1f}M' if x >= 1e6 else f'{x/1e3:.0f}K'
))
```

**影响范围**:
- `_draw_top10_trend()` 方法：Top 10 个股趋势图（1个月 + 3个月）
- `_draw_new_stocks_trend()` 方法：新增持仓股票趋势图

**数据变更**:
| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 跟踪数据 | `weight` (权重 %) | `shares` (持股数) |
| Y轴标签 | "权重 (%)" | "持股数" |
| Y轴格式 | 数字 | 1.2M / 345K |
| 标题 | "权重趋势" | "持股数趋势" |

---

## 测试验证

### 执行测试
```bash
./test_fixes_v2.sh
```

### 验证清单
- [ ] **图一（汇总报告）**: 各基金显示 **Top 10**（而非 Top 3）
- [ ] **图二（ARKK长图）**: 基金总额趋势图正常显示（不再是0天数据）
- [ ] **图二（所有基金长图）**: Top 10 个股趋势图Y轴显示 **"持股数"**（格式为 1.2M）

### 预期效果
1. **文字消息**: 每个基金后显示 10 只股票的代码和权重
   ```
   Top 10: TSLA 12.0% · ROKU 5.8% · COIN 5.7% · ...
   ```

2. **ARKK 趋势图**: 
   - 基金总额趋势：显示近1个月和3个月的数据（不再提示"历史数据不足"）
   - Top 10 趋势：Y轴显示"持股数"，数值格式为"1.2M"、"345K"

3. **所有基金长图**: 
   - Top 10 个股趋势图标题："{ETF} Top 10 个股**持股数**趋势"
   - Y轴：持股数（而非权重 %）
   - 新增股票趋势图：同样改为持股数

---

## 修改文件清单

| 文件 | 修改行数 | 修改内容 |
|------|----------|----------|
| `src/summary_notifier.py` | ~5行 | Top 3 → Top 10 |
| `src/image_generator.py` | ~100行 | 权重趋势 → 持股数趋势 |

---

## 相关命令

```bash
# 补充历史数据
python3 main.py --backfill --days 90

# 测试运行
python3 main.py --manual

# 查看ARKK历史数据
ls -la data/holdings/ARKK/

# 运行测试脚本
./test_fixes_v2.sh
```

---

## 注意事项

1. **历史数据补充**: 
   - 如果未来数据再次不足，可以重新执行 `--backfill` 命令
   - 建议配置 `config.yaml` 中的 `auto_download_history: true`（已默认开启）

2. **持股数趋势图**: 
   - Y轴自动格式化为M（百万）或K（千）
   - 如果股票在某日期不存在，显示为0（表示未持仓）

3. **性能优化**: 
   - 读取历史数据时只处理最近90天（可在代码中调整）
   - 图表生成时自动跳过数据不足的情况

---

**修复完成时间**: 2025-11-14  
**修复人**: AI Assistant  
**版本**: v2
