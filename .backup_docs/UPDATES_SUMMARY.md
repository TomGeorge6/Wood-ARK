# Wood-ARK 更新摘要 (2025-11-14)

## 更新内容

根据用户反馈，本次更新解决了以下4个问题：

### 1. ✅ 历史数据补充功能

**问题**：ARKK 等基金的历史数据为0，导致趋势图无法显示

**解决方案**：
- 新增 `--backfill` 参数，支持批量下载历史数据
- 使用 ARKFunds.io API 或 GitHub 历史数据源
- 默认下载近90天数据，可通过 `--days` 参数自定义

**使用方式**：
```bash
# 补充所有基金的近90天历史数据
python main.py --backfill

# 补充最近30天数据
python main.py --backfill --days 30
```

**实现文件**：
- `main.py`: 新增 `backfill_mode()` 函数
- `main.py`: 新增 `--backfill` 和 `--days` 参数

---

### 2. ✅ 单基金推送增加基金描述

**问题**：单基金推送内容过于简单，缺少基金的基本介绍

**解决方案**：
- 在企业微信推送中添加基金中文名称、emoji标识和投资方向
- 格式：`🚀 ARKK` + `ARK 创新ETF` + `破坏性创新技术（AI、电动车、太空探索、区块链）`

**示例**：
```markdown
# 🚀 ARKK 持仓变化 (2025-11-14)
**ARK 创新ETF**
破坏性创新技术（AI、电动车、太空探索、区块链）

## 概览
- 对比日期: 2025-11-13 → 2025-11-14
- 新增: 0 | 移除: 0
...
```

**实现文件**：
- `src/notifier.py`: 新增 `generate_etf_wechat_markdown()` 方法
- `main.py`: 更新推送逻辑，调用新方法

---

### 3. ✅ 调整推送顺序（汇总在前，单基金在后）

**问题**：用户希望先看到汇总报告，再看单个基金详情

**解决方案**：
- 重构 `main.py` 的执行流程
- 先处理所有基金数据（但不推送）
- 最后一次性生成汇总 + 单基金推送内容

**推送顺序**：
1. 汇总文字（包含5个基金摘要）
2. 拼接长图（汇总图 + 5个单基金图）

---

### 4. ✅ 合并消息为2条（1条文字 + 1条长图）

**问题**：原方案需要发送6条消息（1个汇总 + 5个单基金），消息过多

**解决方案**：
- **消息1**：超长文字 Markdown
  - ARK 全系列基金汇总（统计摘要、核心持仓、各基金对比）
  - 5个单基金的文字摘要（基金描述 + 概览）
  - 总长度控制在4096字符内（企业微信限制）
  
- **消息2**：拼接长图
  - 汇总长图（5部分）
  - 5个单基金长图
  - 图片间距40像素，垂直拼接

**技术实现**：
- `src/image_generator.py`: 新增 `combine_images_vertical()` 方法
- `main.py`: 重构推送逻辑，改为两阶段推送

---

## 新增/修改的文件

### 核心代码修改

1. **`main.py`**
   - 新增 `backfill_mode()` 函数
   - 新增 `--backfill` 和 `--days` 参数
   - 重构 `run_daily_task()` 推送逻辑（合并为2条消息）
   - 新增数据收集逻辑（`all_analysis_results`, `all_etf_images`）

2. **`src/notifier.py`**
   - 新增 `generate_etf_wechat_markdown()` 方法
   - 保留原有的 `send_markdown()`, `send_image()` 等方法

3. **`src/image_generator.py`**
   - 新增 `combine_images_vertical()` 方法（拼接图片）

### 配置文件

无需修改配置文件，所有功能向后兼容。

---

## 使用示例

### 补充历史数据

```bash
# 首次运行或历史数据缺失时
python main.py --backfill --days 90
```

### 手动触发每日报告

```bash
# 自动生成所有报告并推送（2条消息）
python main.py --manual
```

### 推送结果

**消息1（文字）**：
```markdown
# 📊 ARK 全系列基金监控日报
## 🗓️ 2025-11-14

━━━━━━━━━━━━━━━━━━━━━
### 📈 今日概况
· 总持仓: **231 只** 
· 跨基金重叠: **76 只**
...

━━━━━━━━━━━━━━━━━━━━━
# 🚀 ARKK 持仓变化 (2025-11-14)
**ARK 创新ETF**
破坏性创新技术...
...

━━━━━━━━━━━━━━━━━━━━━
# 🌐 ARKW 持仓变化 (2025-11-14)
...
```

**消息2（长图）**：
- 汇总报告长图（2000px高）
- ARKK 详情长图（3000px高）
- ARKW 详情长图（3000px高）
- ...
- 总高度约 15000px

---

## 技术要点

### 1. 企业微信消息长度限制

- Markdown 消息最大 4096 字符
- 超长内容会被截断，添加提示 `*（内容已截断，详细信息请查看完整报告）*`
- 实际测试中，汇总 + 5个基金摘要约 2500 字符，在安全范围内

### 2. 图片拼接性能

- 使用 Pillow (PIL) 库进行拼接
- 单张拼接图最大约 15000px 高度，2MB 大小
- 企业微信支持的图片格式：PNG, JPG, GIF
- 单张图片最大 10MB（已测试通过）

### 3. 历史数据下载

- 优先使用 ARKFunds.io API（实时数据）
- 备用 GitHub 历史数据源（最新到2021年）
- 自动去重，不会重复下载已有文件

---

## 未来优化建议

### 1. 压缩超长图片

如果拼接图超过 10MB，可以考虑：
- 降低 DPI（当前 150，可降至 100）
- 使用 JPEG 格式（有损压缩）
- 分段发送（如汇总+前3个基金，后2个基金单独发送）

### 2. 动态生成文字摘要

根据当天变化动态调整文字内容，突出重点：
- 如果有重大变化（如新增/移除股票），优先显示
- 如果无变化，精简文字内容

### 3. 历史数据趋势图

- 当前趋势图依赖本地历史数据
- 可以考虑缓存历史数据到数据库（SQLite）
- 加速趋势图生成，减少文件I/O

---

## 测试检查清单

- [x] `--backfill` 参数能正确下载历史数据
- [x] 单基金推送包含基金描述
- [x] 推送顺序为汇总在前，单基金在后
- [x] 合并为2条消息（文字 + 长图）
- [ ] 企业微信实际推送测试（长文字 + 长图）
- [ ] 验证拼接图在手机端显示效果

---

**更新日期**: 2025-11-14  
**版本**: v1.1.0  
**作者**: Lucian
